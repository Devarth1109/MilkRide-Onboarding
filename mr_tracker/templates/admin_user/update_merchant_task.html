{% extends 'dashboard_headers.html' %}
{% load static %}
{% block content %}

<div class="content-wrapper">
  <div class="row mt-0">
    <div class="col-md-8 mx-auto">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Edit Merchant Task</h5>
        </div>
        <div class="card-body">
          {% if error %}
              <div class="alert alert-danger">{{ error }}</div>
          {% endif %}

          <form action="{% url 'update_merchant_task' task.id %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="task_template_id">Select Task Template:</label>
                <select class="form-control form-control-lg" id="task_template_id" name="task_template_id" onchange="fillTemplateFields()">
                  <option value="" {% if not task.task_template %}selected{% endif %}>+ ADD</option>
                  {% for template in task_templates %}
                    <option value="{{ template.id }}"
                      data-name="{{ template.task_name|escapejs }}"
                      data-description="{{ template.task_description|escapejs }}"
                      {% if task.task_template and template.id == task.task_template.id %}selected{% endif %}
                    >{{ template.task_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-group col-md-6">
                <label for="category_id">Category</label>
                <select id="category_id" name="category_id" class="form-control form-control-lg" required>
                  {% for category in categories %}
                      <option value="{{ category.id }}" {% if category.id == task.category.id %}selected{% endif %}>{{ category.cat_name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="name">Task Name</label>
                <input type="text" class="form-control form-control-lg" id="name" name="name"
                  value="{% if task.task_template %}{{ task.task_template.task_name }}{% else %}{{ task.custom_task_name }}{% endif %}"
                  {% if task.task_template %}readonly{% endif %} required>
              </div>
              <div class="form-group col-md-6">
                <label for="description">Description</label>
                <textarea id="description" name="description" class="form-control form-control-lg" {% if task.task_template %}readonly{% endif %} required>{% if task.task_template %}{{ task.task_template.task_description }}{% else %}{{ task.custom_task_description }}{% endif %}</textarea>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="status">Status</label>
                <select id="status" name="status" class="form-control form-control-lg" required>
                  <option value="pending" {% if task.status == 'pending' %}selected{% endif %}>Pending</option>
                  <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                  <option value="on_hold" {% if task.status == 'on_hold' %}selected{% endif %}>On Hold</option>
                  <option value="completed" {% if task.status == 'completed' %}selected{% endif %}>Completed</option>
                </select>
              </div>
              <div class="form-group col-md-6">
                <label for="start_date">Start Date</label>
                <input type="date" id="start_date" name="start_date" class="form-control form-control-lg" value="{{ task.start_date|date:'Y-m-d' }}">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label for="due_date">Due Date</label>
                <input type="date" id="due_date" name="due_date" class="form-control form-control-lg" value="{{ task.due_date|date:'Y-m-d' }}">
              </div>
              <div class="form-group col-md-6">
                <label for="end_date">End Date</label>
                <input type="date" id="end_date" name="end_date" class="form-control form-control-lg" value="{{ task.end_date|date:'Y-m-d' }}">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-12">
                <button class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn" type="submit">Update</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function fillTemplateFields() {
    var select = document.getElementById('task_template_id');
    var selected = select.options[select.selectedIndex];
    var name = selected.getAttribute('data-name');
    var description = selected.getAttribute('data-description');
    if (select.value) {
        document.getElementById('name').value = name;
        document.getElementById('description').value = description;
        document.getElementById('name').readOnly = true;
        document.getElementById('description').readOnly = true;
    } else {
        document.getElementById('name').value = "{{ task.custom_task_name|escapejs }}";
        document.getElementById('description').value = "{{ task.custom_task_description|escapejs }}";
        document.getElementById('name').readOnly = false;
        document.getElementById('description').readOnly = false;
    }
}
window.onload = fillTemplateFields;
</script>

{% endblock %}