{% extends 'dashboard_headers.html' %}
{% load static %}
{% block content %}
<div class="content-wrapper">
    <div class="row mt-0">
        <div class="col-md-8 mx-auto">
            <div class="card" style="background-color: #d3e4f4;">
                <div class="card-header" style="background-color: #3697b4; color: #ffffff;">
                    <h5 class="mb-0">Add Merchant Tasks</h5>
                </div>
                <div class="card-body">
                    <div id="added-tasks-list" class="mb-3">
                        <h6>Added Tasks</h6>
                        <table class="table table-striped table-hover table-bordered project-orders-table">
                            <thead style="background-color: #64bdd3; color: #ffffff; font-weight: bold;">
                                <tr>
                                    <th>#</th>
                                    <th>Category</th>
                                    <th>Task</th>
                                    <th>Start Date</th>
                                    <th>Due Date</th>
                                </tr>
                            </thead>
                            <tbody id="tasks-table-body">
                                {% for t in tasks %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ t.category.cat_name }}</td>
                                    <td>{{ t.custom_task_name }}</td>
                                    <td>{{ t.start_date }}</td>
                                    <td>{{ t.due_date }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <form id="merchant-task-form" method="POST" enctype="multipart/form-data" onsubmit="return false;">
                        {% csrf_token %}
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="category_id">Category:</label>
                                <select class="form-control form-control-lg" id="category_id" name="category_id" onchange="loadTaskTemplates()" required>
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}">{{ category.cat_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="task_template_id">Select Task Template:</label>
                                <select class="form-control form-control-lg" id="task_template_id" name="task_template_id" onchange="toggleCustomTaskFields()" disabled>
                                    <option value="">First select a category</option>
                                </select>
                                <div id="loading" style="display: none; margin-top: 5px;">
                                    <small class="text-muted">Loading templates...</small>
                                </div>
                            </div>
                            <div class="form-group col-md-6" id="custom-task-fields" style="display: none;">
                                <input type="text" class="form-control form-control-lg mb-2" id="name" name="name" placeholder="Task Name">
                                <input type="text" class="form-control form-control-lg mb-2" id="description" name="description" placeholder="Description">
                                <input type="number" class="form-control form-control-lg mb-2" id="duration" name="duration" placeholder="Duration (days)" min="1" required>
                                <select class="form-control form-control-lg" id="priority" name="priority" required>
                                    <option value="medium" selected>Medium</option>
                                    <option value="low">Low</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="support_user_id">Assigned Support User:</label>
                                <input type="text" class="form-control form-control-lg" id="support_user_display"
                                    value="{{ merchant.assigned_manager.user_name }} ({{ merchant.assigned_manager.user_email }})" readonly>
                                <input type="hidden" id="support_user_id" name="support_user_id" value="{{ merchant.assigned_manager.id }}">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="status">Status:</label>
                                <select class="form-control form-control-lg" id="status" name="status" required>
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="on_hold">On Hold</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="start_date">Start Date:</label>
                                <input type="date" class="form-control form-control-lg" id="start_date" name="start_date">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="due_date">Due Date:</label>
                                <input type="date" class="form-control form-control-lg" id="due_date" name="due_date">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="end_date">End Date:</label>
                                <input type="date" class="form-control form-control-lg" id="end_date" name="end_date">
                            </div>
                        </div>
                        <!-- Replace submit button with +Add -->
                        <div class="mt-3">
                            <button class="btn btn-block btn-info btn-lg font-weight-medium auth-form-btn"
                                type="button" onclick="addTaskAjax()">+ Add</button>
                        </div>
                    </form>
                    <div class="mt-3">
                        <button class="btn btn-secondary btn-block btn-lg font-weight-medium auth-form-btn"
                            onclick="window.location.href='{% url 'view_merchant_tasks' merchant.id %}'">View Merchant Tasks</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let templateDurations = {};

function loadTaskTemplates() {
    const categorySelect = document.getElementById('category_id');
    const templateSelect = document.getElementById('task_template_id');
    const loading = document.getElementById('loading');
    const selectedCategoryId = categorySelect.value;
    
    templateDurations = {}; // Reset durations

    templateSelect.innerHTML = '';
    
    if (!selectedCategoryId) {
        templateSelect.disabled = true;
        templateSelect.innerHTML = '<option value="">First select a category</option>';
        toggleCustomTaskFields();
        return;
    }
    
    // Show loading indicator
    loading.style.display = 'block';
    templateSelect.disabled = true;
    templateSelect.innerHTML = '<option value="">Loading...</option>';
    
    // Fetch task templates via AJAX
    fetch(`{% url 'get_task_templates_by_category' %}?category_id=${selectedCategoryId}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            templateSelect.disabled = false;
            
            if (data.error) {
                templateSelect.innerHTML = '<option value="">Error loading templates</option>';
                return;
            }
            
            // Add default option
            templateSelect.innerHTML = '<option value="">Select Task Template</option>';
            
            // Add task templates
            data.templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.task_name;
                templateSelect.appendChild(option);
                templateDurations[template.id] = template.duration; // Store duration
            });
            
            // Add custom task option
            const customOption = document.createElement('option');
            customOption.value = '';
            customOption.textContent = '+ ADD CUSTOM TASK';
            templateSelect.appendChild(customOption);
            
            // Reset custom fields visibility
            toggleCustomTaskFields();
        })
        .catch(error => {
            console.error('Error fetching task templates:', error);
            loading.style.display = 'none';
            templateSelect.disabled = false;
            templateSelect.innerHTML = '<option value="">Error loading templates</option>';
        });
}

function toggleCustomTaskFields() {
    const templateSelect = document.getElementById('task_template_id');
    const customFields = document.getElementById('custom-task-fields');
    const categorySelect = document.getElementById('category_id');
    
    if (!categorySelect.value) {
        customFields.style.display = 'none';
        setCustomFieldsRequired(false);
        return;
    }
    
    if (templateSelect.value && templateSelect.value !== '') {
        customFields.style.display = 'none';
        setCustomFieldsRequired(false);
    } else {
        customFields.style.display = 'block';
        setCustomFieldsRequired(true);
    }
    updateDueDate(); // Update due date when toggling fields
}

function setCustomFieldsRequired(required) {
    document.getElementById('name').required = required;
    document.getElementById('description').required = required;
    document.getElementById('duration').required = required;
    document.getElementById('priority').required = required;
}

function updateDueDate() {
    const templateSelect = document.getElementById('task_template_id');
    const startDateInput = document.getElementById('start_date');
    const dueDateInput = document.getElementById('due_date');
    const durationInput = document.getElementById('duration');

    let duration = null;

    if (templateSelect.value && templateDurations[templateSelect.value]) {
        duration = parseInt(templateDurations[templateSelect.value]);
    } else if (durationInput && durationInput.value) {
        duration = parseInt(durationInput.value);
    }

    if (startDateInput.value && duration && !isNaN(duration)) {
        const startDate = new Date(startDateInput.value);
        startDate.setDate(startDate.getDate() + duration);
        const yyyy = startDate.getFullYear();
        const mm = String(startDate.getMonth() + 1).padStart(2, '0');
        const dd = String(startDate.getDate()).padStart(2, '0');
        dueDateInput.value = `${yyyy}-${mm}-${dd}`;
    }
}

// Listen for changes
document.getElementById('task_template_id').addEventListener('change', function() {
    toggleCustomTaskFields();
    updateDueDate();
});
document.getElementById('start_date').addEventListener('change', updateDueDate);
document.getElementById('duration').addEventListener('input', updateDueDate);

// Initialize on page load
window.onload = function() {
    toggleCustomTaskFields();
    updateDueDate();
};

function addTaskAjax() {
    const form = document.getElementById('merchant-task-form');
    const formData = new FormData(form);

    fetch("{% url 'add_merchant_task' merchant.id %}?ajax=1", {
        method: "POST",
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add new row to tasks table
            const tbody = document.getElementById('tasks-table-body');
            const row = document.createElement('tr');
            row.innerHTML = `<td>${data.task.category}</td>
                             <td>${data.task.name}</td>
                             <td>${data.task.start_date}</td>
                             <td>${data.task.due_date}</td>`;
            tbody.appendChild(row);

            // Reset form
            form.reset();
            toggleCustomTaskFields();
            updateDueDate();
        } else {
            alert(data.error || "Error adding task");
        }
    })
    .catch(err => {
        alert("Error adding task");
        console.error(err);
    });
}
</script>
{% endblock %}